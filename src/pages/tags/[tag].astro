---
import BaseLayout from '../../layouts/BaseLayout.astro';
import EntryPreview from '../../components/EntryPreview.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allEntries = await getCollection('entries', ({ data }) => !data.draft);

  const tagMap = new Map<string, typeof allEntries>();
  for (const entry of allEntries) {
    for (const tag of entry.data.tags) {
      if (!tagMap.has(tag)) tagMap.set(tag, []);
      tagMap.get(tag)!.push(entry);
    }
  }

  return [...tagMap.entries()].map(([tag, entries]) => ({
    params: { tag },
    props: {
      tag,
      entries: entries.sort(
        (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
      ),
    },
  }));
}

const { tag, entries } = Astro.props;
---

<BaseLayout title={`${tag} â€” The Daily Sublime`}>
  <h1 class="page-title">{tag}</h1>

  <p style="font-family: var(--font-sans); font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-6);">
    {entries.length} {entries.length === 1 ? 'entry' : 'entries'} &middot; <a href="/tags">All themes</a>
  </p>

  <ul class="entry-list" role="list">
    {entries.map((entry) => (
      <li><EntryPreview entry={entry} /></li>
    ))}
  </ul>
</BaseLayout>
